#!/usr/bin/env python3

"""
SYNC TO NOTES - Push analyzed projects to Notes.test database
"""

import json
import os
import sys
import requests
from typing import Dict, Any

# Configuration
PROJECT_DATA_DIR = os.path.expanduser("~/.project_data")
SYNC_DATA_FILE = os.path.join(PROJECT_DATA_DIR, "notes_sync_data.json")

# Notes.test API Configuration
NOTES_API_URL = os.environ.get('NOTES_API_URL', 'http://notes.test/api')
NOTES_API_TOKEN = os.environ.get('NOTES_API_TOKEN')  # Optional for now

# ANSI color codes
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
CYAN = '\033[0;36m'
BOLD = '\033[1m'
NC = '\033[0m'


def log_info(msg: str):
    print(f"{BLUE}[INFO]{NC} {msg}")


def log_success(msg: str):
    print(f"{GREEN}[SUCCESS]{NC} {msg}")


def log_warning(msg: str):
    print(f"{YELLOW}[WARNING]{NC} {msg}")


def log_error(msg: str):
    print(f"{RED}[ERROR]{NC} {msg}", file=sys.stderr)


def log_detail(msg: str):
    print(f"  {CYAN}→{NC} {msg}")


def load_sync_data() -> Dict[str, Any]:
    """Load the sync data generated by project-organizer-ai.py"""
    if not os.path.exists(SYNC_DATA_FILE):
        log_error(f"Sync data file not found: {SYNC_DATA_FILE}")
        log_info("Run project-organizer-ai first to generate sync data")
        sys.exit(1)
    
    with open(SYNC_DATA_FILE, 'r') as f:
        return json.load(f)


def check_api_connection() -> bool:
    """Test connection to Notes.test API"""
    try:
        response = requests.get(
            f"{NOTES_API_URL}/sync/stats",
            timeout=5
        )
        
        if response.status_code == 200:
            data = response.json()
            log_success(f"Connected to Notes.test API")
            log_detail(f"Current stats: {data['stats']['total_projects']} projects, {data['stats']['total_notes']} notes")
            return True
        else:
            log_error(f"API returned status {response.status_code}")
            return False
            
    except requests.exceptions.RequestException as e:
        log_error(f"Cannot connect to Notes.test API at {NOTES_API_URL}")
        log_error(f"Error: {e}")
        log_info("")
        log_info("Make sure:")
        log_info("  1. Notes.test is running (php artisan serve)")
        log_info("  2. API routes are configured")
        log_info("  3. NOTES_API_URL is correct (default: http://notes.test/api)")
        return False


def preview_sync(sync_data: Dict[str, Any]):
    """Show what will be synced"""
    print()
    print(f"{BOLD}=== SYNC PREVIEW ==={NC}")
    print()
    print(f"Total projects to sync: {BOLD}{sync_data['total_projects']}{NC}")
    print()
    
    for i, project in enumerate(sync_data['projects'][:5], 1):
        proj_data = project['project_data']
        note_data = project['note_data']
        tags = project.get('tags', [])
        flags = project.get('flags', [])
        
        print(f"{CYAN}[{i}]{NC} {BOLD}{proj_data['name']}{NC}")
        log_detail(f"Description: {proj_data['description'][:60]}...")
        log_detail(f"Tags: {', '.join([t['name'] for t in tags])}")
        if flags:
            log_detail(f"Flags: {', '.join([f['name'] for f in flags])}")
        print()
    
    if sync_data['total_projects'] > 5:
        print(f"... and {sync_data['total_projects'] - 5} more projects")
        print()


def sync_to_api(sync_data: Dict[str, Any], dry_run: bool = True) -> Dict[str, Any]:
    """Sync projects to Notes.test API"""
    
    if dry_run:
        log_info("DRY RUN MODE - No data will be sent")
        preview_sync(sync_data)
        return {"success": True, "dry_run": True}
    
    log_info(f"Syncing {sync_data['total_projects']} projects to Notes.test...")
    
    try:
        headers = {"Content-Type": "application/json"}
        
        # Add API token if available
        if NOTES_API_TOKEN:
            headers["Authorization"] = f"Bearer {NOTES_API_TOKEN}"
        
        # Make the sync request
        response = requests.post(
            f"{NOTES_API_URL}/sync/projects",
            headers=headers,
            json={"projects": sync_data['projects']},
            timeout=60
        )
        
        response.raise_for_status()
        result = response.json()
        
        if result.get('success'):
            log_success(f"Successfully synced {result.get('synced', 0)} projects!")
            
            # Show results
            for project_result in result.get('results', []):
                log_detail(f"✓ {project_result['project_name']} → Note ID: {project_result['note_id']}")
            
            return result
        else:
            log_error("Sync failed")
            if 'errors' in result:
                for error in result['errors']:
                    log_error(f"  {error['project']}: {error['error']}")
            return result
            
    except requests.exceptions.RequestException as e:
        log_error(f"API request failed: {e}")
        return {"success": False, "error": str(e)}


def show_next_steps():
    """Display next steps after sync"""
    print()
    print(f"{BOLD}=== NEXT STEPS ==={NC}")
    print()
    log_info("Your projects are now in Notes.test!")
    print()
    log_detail("Open Notes.test: http://notes.test/admin")
    log_detail("View Projects: http://notes.test/admin/projects")
    log_detail("View Notes: http://notes.test/admin/notes")
    log_detail("Manage Tags: http://notes.test/admin/tags")
    print()
    log_info("Try searching for:")
    log_detail("Projects by tag (e.g., 'laravel', 'vue', 'python')")
    log_detail("Projects by flag (e.g., 'revenue-generating', 'needs-attention')")
    log_detail("Full-text search across all project documentation")
    print()


def main():
    """Main function"""
    import argparse
    
    parser = argparse.ArgumentParser(
        description="Sync analyzed projects to Notes.test",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  sync-to-notes                    # Dry run (preview only)
  sync-to-notes --execute          # Actually sync to Notes.test
  sync-to-notes --api-url http://localhost:8000/api
        """
    )
    
    parser.add_argument(
        '--execute',
        action='store_true',
        help='Actually sync data (default is dry-run)'
    )
    
    parser.add_argument(
        '--api-url',
        type=str,
        help=f'Notes.test API URL (default: {NOTES_API_URL})'
    )
    
    args = parser.parse_args()
    
    # Override API URL if provided
    if args.api_url:
        global NOTES_API_URL
        NOTES_API_URL = args.api_url
    
    # Header
    print()
    log_info("Sync to Notes.test")
    log_info("==================")
    print()
    
    # Load sync data
    log_info(f"Loading sync data from {SYNC_DATA_FILE}")
    sync_data = load_sync_data()
    log_success(f"Loaded {sync_data['total_projects']} projects")
    print()
    
    # Check API connection
    log_info(f"Checking connection to {NOTES_API_URL}")
    if not check_api_connection():
        sys.exit(1)
    
    print()
    
    # Perform sync
    dry_run = not args.execute
    
    if dry_run:
        log_warning("DRY RUN MODE")
        log_info("No data will be sent to the API")
        log_info("Use --execute to actually sync")
        print()
    else:
        log_warning("EXECUTE MODE")
        log_info("Data will be sent to Notes.test!")
        print()
        
        # Ask for confirmation
        confirm = input(f"{YELLOW}Continue? (yes/no): {NC}")
        if confirm.lower() != 'yes':
            log_info("Sync cancelled")
            sys.exit(0)
        print()
    
    # Sync
    result = sync_to_api(sync_data, dry_run=dry_run)
    
    # Show results
    if result.get('success') and not dry_run:
        show_next_steps()
    elif dry_run:
        print()
        log_info(f"To actually sync, run: {CYAN}sync-to-notes --execute{NC}")
        print()


if __name__ == "__main__":
    main()
